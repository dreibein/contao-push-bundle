"serviceWorker"in navigator&&document.addEventListener("DOMContentLoaded",()=>{let e=!1;const n=document.getElementById("push-subscription-container"),t=document.getElementById("push-subscription-button");if(!n||!t)return;if(!(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream)){if(n.style.display="block",t.addEventListener("click",function(){e?(i("computing"),navigator.serviceWorker.ready.then(e=>e.pushManager.getSubscription()).then(e=>{if(e)return o(e,"DELETE");i("disabled")}).then(e=>e.unsubscribe()).then(()=>i("disabled")).catch(e=>{console.error("Error when unsubscribing the user",e),i("disabled")})):(i("computing"),new Promise((e,n)=>"denied"===Notification.permission?n(new Error("Push messages are blocked.")):"granted"===Notification.permission?e():"default"===Notification.permission?Notification.requestPermission().then(t=>{"granted"!==t&&n(new Error("Bad permission result")),e()}):void 0).then(()=>navigator.serviceWorker.ready).then(e=>e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:r(applicationServerKey)})).then(e=>o(e,"POST")).then(e=>e&&i("enabled")).catch(e=>{"denied"===Notification.permission?(console.warn("Notifications are denied by the user."),i("incompatible")):(console.error("Impossible to subscribe to push notifications",e),i("disabled"))}))}),!("serviceWorker"in navigator))return console.warn("Service workers are not supported by this browser"),void i("incompatible");if(!("PushManager"in window))return console.warn("Push notifications are not supported by this browser"),void i("incompatible");if(!("showNotification"in ServiceWorkerRegistration.prototype))return console.warn("Notifications are not supported by this browser"),void i("incompatible");if("denied"===Notification.permission)return console.warn("Notifications are denied by the user"),void i("incompatible");navigator.serviceWorker.register("/contao-push-sw.js",{scope:"/"}).then(()=>{console.log("[SW] Service worker has been registered"),navigator.serviceWorker.ready.then(e=>e.pushManager.getSubscription()).then(e=>{if(i("disabled"),e)return o(e,"PUT")}).then(e=>e&&i("enabled")).catch(e=>{console.error("Error when updating the subscription",e)})},e=>{console.error("[SW] Service worker registration failed",e),i("incompatible")})}function i(i){switch(i){case"enabled":e=!0,t.disabled=!1,t.textContent=t.dataset.disable;break;case"disabled":e=!1,t.disabled=!1,t.textContent=t.dataset.enable;break;case"computing":t.disabled=!0;break;case"incompatible":t.disabled=!0,console.error("Push notifications are not compatible with this browser"),n.style.display="none";break;default:console.error("Unhandled push button state",i)}}function r(e){const n=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(n),i=new Uint8Array(t.length);for(let e=0;e<t.length;++e)i[e]=t.charCodeAt(e);return i}function o(e,n){const t=e.getKey("p256dh"),i=e.getKey("auth"),r=(PushManager.supportedContentEncodings||["aesgcm"])[0];return fetch("_push/subscription",{method:n,body:JSON.stringify({endpoint:e.endpoint,publicKey:t?btoa(String.fromCharCode.apply(null,new Uint8Array(t))):null,authToken:i?btoa(String.fromCharCode.apply(null,new Uint8Array(i))):null,contentEncoding:r})}).then(()=>e)}});